```{eval-rst}
.. meta::
   :description: Численное дифференцирование методом комплексного шага.
   :keywords: дуальное число, автоматическое дифференцирование, производная, вычислительная математика, вычматы
```

# Дуальные числа

Дуальные числа тесно связаны с дифференцированием, а на основе арифметики с ними можно создать алгоритм автоматического дифференцирования вперёд.

```{index} число; дуальное
```
````{proof:definition} Множество дуальных чисел
Дуальные числа $\dualset$ расширяют[^hypercomplexnumbers] действительные числа $\real$ числом $\dual$, для которого определяются следующие правила

```{math}
\dual{}  \neq 0, \quad \dual{} \times 0 = 0, \quad \text{но} \quad \dual{} \times \dual{}  = \dual{}^2 = 0.
```

[^hypercomplexnumbers]: Расширение множества действительных чисел называют гиперкомплексными числами. Комплексные, дуальные числа, и, например, квартерионы являются гиперкомплексными числами.
````

Например, в дуальных числах уравнение $x^2 = 0$ имеет множество корней: $0, \dual{}^2, \dual{}^3,\dots$

Определим запись дуальных чисел аналогично записи комплексных
```{math}
  a + b \dual, \quad a, b \in \real,
```
где $a$ назовём действительной частью (компонентой) числа, а $b$ --- дуальной.

Сложение и вычитание чисел определяется интуитивно, покомпонентно
```{math}
\begin{align}
\begin{split}
  (a + b \dual) + (c + d \dual) = (a + c) + (b + d)\dual,
  \\
  (a + b \dual) - (c + d \dual) = (a - c) + (b - d)\dual.
\end{split}
\end{align}
```

При произведении проявляется природа числа $\dual$
```{math}
(a + b \dual)(c + d \dual) = ac + a d \dual + b c \dual + \cancel{b d \dual^2}
= ac + (a d + b c)\dual.
```
Такое поведение может напомнить пренебрежение квадратичными поправками.
Например, можно считать, что $b\dual$ и $d\dual$ являются погрешностями значений $a$ и $c$.
Тогда $b d \dual^2$ мало по сравнению с остальными слагаемыми, и пренебрегается.

Деление дуальных чисел можно представить домножением числителя и знаменателя на сопряжённое к знаменателю (при этом знаменатель ненулевой, $c + d\dual \neq 0$)
```{math}
\frac{a + b\dual}{c + d\dual}
= \frac{(a + b\dual)(c - d \dual)}{(c + d\dual)(c - d\dual)}
= \frac{ac + (-ad + bc)\dual}{c^2}
= \frac{a}{c} + \frac{bc - ad}{c^2}\dual.
```

````{proof:definition} Арифметика дуальных чисел
Сложение, вычитание, произведение и деление дуальных чисел определяются следующим образом.

```{math}
:label: eq:dual_sumsub
(a + b \dual) \pm (c + d \dual) = (a \pm c) + (b \pm d)\dual.
```

```{math}
:label: eq:dual_mul
(a + b \dual)(c + d \dual) = ac + (a d + b c)\dual.
```

```{math}
:label: eq:dual_div
\frac{a + b\dual}{c + d\dual} = \frac{a}{c} + \frac{bc - ad}{c^2}\dual.
```
````


## Связь с дифференцированием

Попробуем вычислить функцию $f$ от дуального числа $a + b\dual{}$.
Для этого воспользуемся разложением Тейлора
```{math}
f(x) = \sum_{k=0}^{\infty} \frac{f^{(k)}(x_0)}{k!} (x - x_0)^k
```
и применим его к $f(a + b\dual{})$
```{math}
\begin{split}
f(a + b\dual) &= \sum_{k=0}^{\infty} \frac{f^{(k)}(a)}{k!} (a + b\dual - a)^k
= \sum_{k=0}^{\infty} \frac{f^{(k)}(a) b^k \dual^k}{k!}
\\ &= f(a) + b f'(a) \dual + \sum_{k=2}^\infty \frac{f^{(k)}(a) b^k \dual^k}{k!}
\\ &= f(a) + b f'(a) \dual + \dual^2 \sum_{k=2}^\infty \frac{f^{(k)}(a) b^k \dual^{k-2}}{k!}
\\ &= f(a) + b f'(a) \dual.
\end{split}
```

Значит, вычислив функцию от дуального числа, получаем дуальное число, в действительной части которого содержится значение функции, а в дуальной содержится её производится.
(Сравните с {ref}` методом комплексного шага <sec:autodiff:complex_step>`.)

Итак, дуальные числа обладают свойством, непосредственно связанным с дифференцированием.

::::{proof:proposition} Значение функции от дуального числа

```{math}
:label: eq:funcofdual

f(a + b\dual) = f(a) + b f'(a)\dual, \quad a, b \in \real.
```
::::

Отметим, что соотношение {eq}`eq:funcofdual` выполняется _аналитически_ точно.

::::{proof:example}

Ниже показаны примеры вычисления функций от дуального числа $3 + 2\dual$.
Чтобы показать определение функции и точку вычисления использована запись $[\text{тело функции}](\text{аргумент})$.
Например, $[x^2 + 3](4)$ означает вычисление $f(x) = x^2 + 3$ в точке 4, т.е. $[x^2 + 3](4) = 4^2 + 3 = 19$.

- Константа
```{math}
\begin{align*}
f(x) &= 5,
\\ f(3 + 2\dual) &= [5](3) + 2 \times [0](3) \dual = 5.
\end{align*}
```
- Полином
```{math}
\begin{align*}
f(x) &= 4x^3 + x,
\\ f(3 + 2 \dual) &= [4 x^3 + x](3) + 2 \times [12 x^2 + 1](3) \times \dual
\\ &= 111 + 2 \times 109 \times \dual = 111 + 218 \dual.
\end{align*}
```
- Логарифм
```{math}
:label: eq:example_log
\begin{split}
f(x) &= \log x,
\\ f(3 + 2 \dual) &= [\log x](3) + 2 \times [1/x](3) \times \dual
   = \log 3 + \frac{2}{3} \dual.
\end{split}
```
::::

Рассмотрим арифметические операции с функциями.
Для этого воспользуемся свойством {eq}`eq:funcofdual` и определениями арифметических операций с дуальными числами {eq}`eq:dual_sumsub`, {eq}`eq:dual_mul` и {eq}`eq:dual_div`.
Начнём рассмотрение со значения суммы функций в точке $a + b\dual$
```{math}
\begin{split}
f(a + b \dual) + g(a + b \dual)
&= (f(a) + b f'(a) \dual) + (g(a) + b g'(a) \dual)
\\ &= (f(a) + g(a)) + b (f'(a) + g'(a)) \dual.
\end{split}
```
В действительной части мы получили сумму функций, а в дуальной присутствует сумма их производных.
Положим $b = 1$ и получим
```{math}
f(a + \dual) + g(a + \dual) = (f(a) + g(a)) + (f'(a) + g'(a)) \dual.
```
Теперь в дуальной части находится сумма производных функций, она же является производной суммы $(f + g)' = f' + g'$.
То есть,
```{math}
[f + g](a + \dual) = [f + g](a) + [f + g]'(a) \times \dual.
```

Итак, мы получили согласие с правилом дифференцирования суммы функций от действительного числа $a$.
Действительная часть соответствует сумме функций в $a$, а дуальная --- производной суммы функций в $a$.
Естественно, аналогичное верно и для вычитания.

Проверим теперь произведение функций
```{math}
\begin{split}
f(a + \dual) \times g(a + \dual) &= (f(a) + f'(a) \dual) \times (g(a) + g'(a) \dual)
\\ &= f(a) g(a) + (f'(a) g(a) + f(a) g'(a)) \dual.
\end{split}
```
И снова есть соответствие.
В действительной части мы получили произведение функций, а в дуальной --- производную произведения функций $(fg)' = f'g + fg'$ в точке $a$
```{math}
[f \times g](a + \dual) = [f \times g](a) + [f \times g]'(a) \times \dual.
```

Наконец, проверим деление функций
```{math}
\begin{split}
\frac{f(a + \dual)}{g(a + \dual)} &= \frac{f(a) + f'(a) \dual}{g(a) + g'(a) \dual}
\\ &= \frac{f(a)}{g(a)} + \frac{f'(a) g(a) - f(a) g'(a)}{g^2(a)} \dual.
\end{split}
```
И снова наблюдается соответствие.
Действительная часть является делением функций, а дуальная --- производной деления функций $(f/g)' = (f'g - f g')/g^2$ в точке $a$
```{math}
[f / g](a + \dual) = [f / g](a) + [f / g]'(a) \dual.
```

Последнее, что осталось проверить, это вычисление сложной (составной) функции
```{math}
g(f(a + \dual)) = g(f(a) + f'(a)\dual) = g(f(a)) + g'(f(a)) f'(a)\dual.
```
Как видно, наблюдается соответствие с правилом дифференцирования сложной функции $(g(f(x)))' = g'(f(x)) f'(x)$
```{math}
[g \circ f](a + \dual) = [g \circ f](a) + [g \circ f]'(a) \times \dual.
```

TODO: автоматическое дифференцирование скалярной функции.
